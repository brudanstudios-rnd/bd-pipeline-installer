{
    "sourceFile": "win32/scripts/installer.ps1",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 9,
            "patches": [
                {
                    "date": 1665568306192,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1665568369176,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -91,4 +91,8 @@\n \r\n if ($LastExitCode -ne 0) {\r\n     exit $LastExitCode\r\n }\r\n+\r\n+[Console]::ForegroundColor = 'green'\r\n+[Console]::WriteLine(\"Successfuly installed BD Remote Pipeline.\")\r\n+[Console]::ResetColor()\r\n"
                },
                {
                    "date": 1665569090360,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -92,7 +92,17 @@\n if ($LastExitCode -ne 0) {\r\n     exit $LastExitCode\r\n }\r\n \r\n+$wscript_obj = New-Object -ComObject (\"WScript.Shell\")\r\n+$shortcut = $wscript_obj.CreateShortcut(\"$env:USERPROFILE\\Desktop\\bd-activate.lnk\")\r\n+\r\n+\r\n+$shortcut.TargetPath = '%BD_PIPELINE_ROOT%\\activate.bat'\r\n+$shortcut.WorkingDirectory = '%BD_PIPELINE_ROOT%'\r\n+$shortcut.IconLocation = ''\r\n+$shortcut.Save()\r\n+\r\n+\r\n [Console]::ForegroundColor = 'green'\r\n [Console]::WriteLine(\"Successfuly installed BD Remote Pipeline.\")\r\n [Console]::ResetColor()\r\n"
                },
                {
                    "date": 1665569286578,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -92,17 +92,16 @@\n if ($LastExitCode -ne 0) {\r\n     exit $LastExitCode\r\n }\r\n \r\n+Copy-Item \"C:\\Wabash\\Logfiles\\mar1604.log.txt\" -Destination \"$env:PIPELINE_ROOT\"\r\n+\r\n $wscript_obj = New-Object -ComObject (\"WScript.Shell\")\r\n $shortcut = $wscript_obj.CreateShortcut(\"$env:USERPROFILE\\Desktop\\bd-activate.lnk\")\r\n-\r\n-\r\n $shortcut.TargetPath = '%BD_PIPELINE_ROOT%\\activate.bat'\r\n $shortcut.WorkingDirectory = '%BD_PIPELINE_ROOT%'\r\n $shortcut.IconLocation = ''\r\n $shortcut.Save()\r\n \r\n-\r\n [Console]::ForegroundColor = 'green'\r\n [Console]::WriteLine(\"Successfuly installed BD Remote Pipeline.\")\r\n [Console]::ResetColor()\r\n"
                },
                {
                    "date": 1665569404671,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -92,15 +92,17 @@\n if ($LastExitCode -ne 0) {\r\n     exit $LastExitCode\r\n }\r\n \r\n-Copy-Item \"C:\\Wabash\\Logfiles\\mar1604.log.txt\" -Destination \"$env:PIPELINE_ROOT\"\r\n+$shortcut_icon = \"$env:PIPELINE_ROOT\\icons\\main.ico\"\r\n \r\n+Copy-Item \"C:\\Wabash\\Logfiles\\mar1604.log.txt\" -Destination $shortcut_icon\r\n+\r\n $wscript_obj = New-Object -ComObject (\"WScript.Shell\")\r\n $shortcut = $wscript_obj.CreateShortcut(\"$env:USERPROFILE\\Desktop\\bd-activate.lnk\")\r\n $shortcut.TargetPath = '%BD_PIPELINE_ROOT%\\activate.bat'\r\n $shortcut.WorkingDirectory = '%BD_PIPELINE_ROOT%'\r\n-$shortcut.IconLocation = ''\r\n+$shortcut.IconLocation = $shortcut_icon\r\n $shortcut.Save()\r\n \r\n [Console]::ForegroundColor = 'green'\r\n [Console]::WriteLine(\"Successfuly installed BD Remote Pipeline.\")\r\n"
                },
                {
                    "date": 1665569501097,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -94,15 +94,15 @@\n }\r\n \r\n $shortcut_icon = \"$env:PIPELINE_ROOT\\icons\\main.ico\"\r\n \r\n-Copy-Item \"C:\\Wabash\\Logfiles\\mar1604.log.txt\" -Destination $shortcut_icon\r\n+Copy-Item \"$PSScriptRoot\\..\\icons\\main.ico\" -Destination $shortcut_icon\r\n \r\n $wscript_obj = New-Object -ComObject (\"WScript.Shell\")\r\n $shortcut = $wscript_obj.CreateShortcut(\"$env:USERPROFILE\\Desktop\\bd-activate.lnk\")\r\n $shortcut.TargetPath = '%BD_PIPELINE_ROOT%\\activate.bat'\r\n $shortcut.WorkingDirectory = '%BD_PIPELINE_ROOT%'\r\n-$shortcut.IconLocation = $shortcut_icon\r\n+$shortcut.IconLocation = '%BD_PIPELINE_ROOT%\\icons\\main.ico'\r\n $shortcut.Save()\r\n \r\n [Console]::ForegroundColor = 'green'\r\n [Console]::WriteLine(\"Successfuly installed BD Remote Pipeline.\")\r\n"
                },
                {
                    "date": 1665569508865,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -92,12 +92,10 @@\n if ($LastExitCode -ne 0) {\r\n     exit $LastExitCode\r\n }\r\n \r\n-$shortcut_icon = \"$env:PIPELINE_ROOT\\icons\\main.ico\"\r\n+Copy-Item \"$PSScriptRoot\\..\\icons\\main.ico\" -Destination \"$env:PIPELINE_ROOT\\icons\\main.ico\"\r\n \r\n-Copy-Item \"$PSScriptRoot\\..\\icons\\main.ico\" -Destination $shortcut_icon\r\n-\r\n $wscript_obj = New-Object -ComObject (\"WScript.Shell\")\r\n $shortcut = $wscript_obj.CreateShortcut(\"$env:USERPROFILE\\Desktop\\bd-activate.lnk\")\r\n $shortcut.TargetPath = '%BD_PIPELINE_ROOT%\\activate.bat'\r\n $shortcut.WorkingDirectory = '%BD_PIPELINE_ROOT%'\r\n"
                },
                {
                    "date": 1665569593887,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -92,10 +92,13 @@\n if ($LastExitCode -ne 0) {\r\n     exit $LastExitCode\r\n }\r\n \r\n-Copy-Item \"$PSScriptRoot\\..\\icons\\main.ico\" -Destination \"$env:PIPELINE_ROOT\\icons\\main.ico\"\r\n+$icons_dir = \"$env:PIPELINE_ROOT\\icons\"\r\n \r\n+New-item -Path $icons_dir -ItemType Directory\r\n+Copy-Item \"$PSScriptRoot\\..\\icons\\main.ico\" -Destination \"$icons_dir\\main.ico\"\r\n+\r\n $wscript_obj = New-Object -ComObject (\"WScript.Shell\")\r\n $shortcut = $wscript_obj.CreateShortcut(\"$env:USERPROFILE\\Desktop\\bd-activate.lnk\")\r\n $shortcut.TargetPath = '%BD_PIPELINE_ROOT%\\activate.bat'\r\n $shortcut.WorkingDirectory = '%BD_PIPELINE_ROOT%'\r\n"
                },
                {
                    "date": 1665570247584,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -92,8 +92,10 @@\n if ($LastExitCode -ne 0) {\r\n     exit $LastExitCode\r\n }\r\n \r\n+[Environment]::SetEnvironmentVariable(\"BD_PIPELINE_ROOT\", $env:PIPELINE_ROOT, \"User\")\r\n+\r\n $icons_dir = \"$env:PIPELINE_ROOT\\icons\"\r\n \r\n New-item -Path $icons_dir -ItemType Directory\r\n Copy-Item \"$PSScriptRoot\\..\\icons\\main.ico\" -Destination \"$icons_dir\\main.ico\"\r\n@@ -104,7 +106,8 @@\n $shortcut.WorkingDirectory = '%BD_PIPELINE_ROOT%'\r\n $shortcut.IconLocation = '%BD_PIPELINE_ROOT%\\icons\\main.ico'\r\n $shortcut.Save()\r\n \r\n+[Environment]::SetEnvironmentVariable\r\n [Console]::ForegroundColor = 'green'\r\n [Console]::WriteLine(\"Successfuly installed BD Remote Pipeline.\")\r\n [Console]::ResetColor()\r\n"
                },
                {
                    "date": 1665571925519,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -95,17 +95,18 @@\n \r\n [Environment]::SetEnvironmentVariable(\"BD_PIPELINE_ROOT\", $env:PIPELINE_ROOT, \"User\")\r\n \r\n $icons_dir = \"$env:PIPELINE_ROOT\\icons\"\r\n+$icon_path = \"$icons_dir\\main.ico\"\r\n \r\n New-item -Path $icons_dir -ItemType Directory\r\n Copy-Item \"$PSScriptRoot\\..\\icons\\main.ico\" -Destination \"$icons_dir\\main.ico\"\r\n \r\n $wscript_obj = New-Object -ComObject (\"WScript.Shell\")\r\n $shortcut = $wscript_obj.CreateShortcut(\"$env:USERPROFILE\\Desktop\\bd-activate.lnk\")\r\n-$shortcut.TargetPath = '%BD_PIPELINE_ROOT%\\activate.bat'\r\n-$shortcut.WorkingDirectory = '%BD_PIPELINE_ROOT%'\r\n-$shortcut.IconLocation = '%BD_PIPELINE_ROOT%\\icons\\main.ico'\r\n+$shortcut.TargetPath = \"$env:PIPELINE_ROOT\\activate.bat\"\r\n+$shortcut.WorkingDirectory = $env:PIPELINE_ROOT\r\n+$shortcut.IconLocation = $icon_path\r\n $shortcut.Save()\r\n \r\n [Environment]::SetEnvironmentVariable\r\n [Console]::ForegroundColor = 'green'\r\n"
                }
            ],
            "date": 1665568306191,
            "name": "Commit-0",
            "content": "function Write-ErrorMessage {\r\n    [CmdletBinding(DefaultParameterSetName = 'ErrorMessage')]\r\n    param(\r\n        [Parameter(Position = 0, ParameterSetName = 'ErrorMessage', ValueFromPipeline, Mandatory)][string]$errorMessage,\r\n        [Parameter(ParameterSetName = 'ErrorRecord', ValueFromPipeline)][System.Management.Automation.ErrorRecord]$errorRecord, \r\n        [Parameter(ParameterSetName = 'Exception', ValueFromPipeline)][Exception]$exception\r\n    )\r\n\r\n    switch ($PsCmdlet.ParameterSetName) {\r\n        'ErrorMessage' {\r\n            $err = $errorMessage\r\n        }\r\n        'ErrorRecord' {\r\n            $errorMessage = @($error)[0]\r\n            $err = $errorRecord\r\n        }\r\n        'Exception' {\r\n            $errorMessage = $exception.Message\r\n            $err = $exception\r\n        }\r\n    }\r\n\r\n    Write-Error -Message $err -ErrorAction SilentlyContinue\r\n    $Host.UI.WriteErrorLine($errorMessage)\r\n}\r\n\r\n$currentPrincipal = New-Object Security.Principal.WindowsPrincipal(\r\n    [Security.Principal.WindowsIdentity]::GetCurrent()\r\n)\r\nif (!($currentPrincipal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator))) {\r\n    Write-ErrorMessage \"[Error] You are not running this with Administrator permissions.\"\r\n    exit 1\r\n}\r\n\r\nif (!(Get-Command 'choco' -erroraction 'silentlycontinue')) {\r\n    [System.Net.ServicePointManager]::SecurityProtocol = 3072\r\n    iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))\r\n    $env:PATH = \"$env:PATH;$env.ALLUSERSPROFILE\\chocolatey\\bin\"\r\n}\r\n\r\nif (!(Get-Command 'git' -erroraction 'silentlycontinue')) {\r\n    choco install git.install -y --params '/GitAndUnixToolsOnPath /WindowsTerminal'\r\n}\r\n\r\nif (!(Get-Command 'python' -erroraction 'silentlycontinue')) {\r\n    choco install python -y --version 3.9.0\r\n}\r\n\r\n$env:PIPELINE_ROOT = \"$env:USERPROFILE\\AppData\\Local\\Programs\\bd-pipeline\"\r\n\r\nif (Test-Path -path \"$env:PIPELINE_ROOT\") {\r\n    Write-ErrorMessage \"[Error] Pipeline is already installed into `\"$env:PIPELINE_ROOT`\" directory.\"\r\n    exit 1\r\n}\r\n\r\n$ssh_key = [RegEx]::Escape(\"$env:USERPROFILE\\.ssh\\bd-ppl_rsa\")\r\n\r\nif (!(Test-Path -path $ssh_key)) {\r\n    ssh-keygen -t ed25519 -f $ssh_key -q -N '\"\"'\r\n}\r\n\r\n$public_ssh_key_content = $(Get-Content \"$ssh_key.pub\")\r\n\r\nWrite-Output \"\"\r\n\r\n[Console]::ForegroundColor = 'red'\r\n[Console]::WriteLine($public_ssh_key_content)\r\n[Console]::ResetColor()\r\n\r\n$public_ssh_key_content | Set-Clipboard\r\n\r\nWrite-Output \"\"\r\n\r\n[Console]::ForegroundColor = 'green'\r\n[Console]::WriteLine(\"Your Public SSH key was printed above and also copied into your Clipboard.\")\r\n[Console]::WriteLine(\"Please send it to your Administrator and wait for the APPROVAL to proceed.\")\r\n[Console]::ResetColor()\r\n\r\nWrite-Output \"\"\r\n\r\n$reply = Read-Host -Prompt \"Have you received the Approval to proceed? [yes/no]\"\r\n\r\nif ($reply.ToLower() -ne \"yes\") {\r\n    exit 1\r\n}\r\n\r\nWrite-Output \"\"\r\n\r\n$env:GIT_SSH_COMMAND = \"ssh -i $ssh_key -o IdentitiesOnly=yes\"\r\ngit clone --depth 1 git@github.com:brudanstudios-rnd/bd-pipeline.git $env:PIPELINE_ROOT\r\n\r\nif ($LastExitCode -ne 0) {\r\n    exit $LastExitCode\r\n}\r\n"
        }
    ]
}